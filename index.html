<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Quiz Master</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23137fec'%3E%3Cpath d='M12 3L1 9l11 6 9-4.91V17h2V9L12 3zm0 8.48L4.69 8 12 4.52 19.31 8 12 11.48z'/%3E%3C/svg%3E">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Theme -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1a2632",
                        "border-light": "#e2e8f0",
                        "border-dark": "#334155",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
          font-variation-settings:
          'FILL' 0,
          'wght' 400,
          'GRAD' 0,
          'opsz' 24
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }
        .full-width .pdf-viewer { display: none; }
        .pdf-viewer-visible .pdf-viewer { display: flex; }
    </style>
    <script>
        // Set theme on initial load to prevent flash
        try {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark')
            } else {
                document.documentElement.classList.remove('dark')
            }
        } catch(e) { console.warn('Theme access denied'); }
    </script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100">

<!-- Landing Page Header -->
<header id="landing-header" class="fixed top-0 left-0 right-0 h-16 bg-surface-light/90 dark:bg-slate-900/90 backdrop-blur-md border-b border-border-light dark:border-border-dark flex justify-between items-center px-6 lg:px-8 z-50">
    <div class="flex items-center gap-3">
        <div class="size-8 bg-primary/10 rounded flex items-center justify-center text-primary">
            <span class="material-symbols-outlined text-xl">school</span>
        </div>
        <h1 class="text-lg font-bold text-slate-900 dark:text-white tracking-tight">Quiz Master</h1>
    </div>
    <div class="flex items-center gap-4">
        <button id="setup-theme-toggle-btn" onclick="toggleTheme()" class="flex items-center justify-center size-9 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 transition-colors" title="Toggle Theme">
            <span id="setup-theme-icon" class="material-symbols-outlined text-[20px]"></span>
        </button>
    </div>
</header>

<!-- SETUP SCREEN -->
<div id="setup-screen" class="min-h-screen flex flex-col items-center justify-center p-6 w-full max-w-7xl mx-auto pt-20">
    <div class="w-full max-w-4xl flex flex-col gap-8"> <!-- Removed redundant pt-16 -->
        <div class="flex flex-col gap-2 text-center">
            <p class="text-slate-500 dark:text-slate-400 text-lg">Upload your configuration files to generate the quiz environment.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- JSON Input -->
            <div class="group relative flex flex-col h-full bg-surface-light dark:bg-surface-dark rounded-xl shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden border border-border-light dark:border-border-dark p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">1. Quiz Structure</h3>
                    <span class="px-2 py-1 rounded text-xs font-medium bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400">Required</span>
                </div>
                
                <textarea id="json-paste" oninput="handleJsonPaste()" placeholder="Paste your JSON quiz data here..." class="w-full h-40 bg-slate-50 dark:bg-[#141e28] border-2 border-slate-300 dark:border-slate-600 rounded-lg p-4 focus:border-primary focus:ring-2 focus:ring-primary/20 transition mb-4 font-mono text-sm resize-none"></textarea>

                <div id="json-drop-area" class="flex-1 flex flex-col items-center justify-center gap-2 rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 group-hover:border-primary/50 bg-slate-50 dark:bg-[#141e28] py-6 transition-colors cursor-pointer">
                    <div class="text-center">
                        <p id="json-status" class="text-slate-900 dark:text-white font-semibold">Or Upload a File</p>
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Drag & drop or click to browse</p>
                    </div>
                </div>
                
                <input type="file" id="file-json" accept=".json" class="hidden" onchange="handleJsonUpload(this)">
            </div>

            <!-- PDF Input -->
            <div class="group relative flex flex-col h-full bg-surface-light dark:bg-surface-dark rounded-xl shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden border border-border-light dark:border-border-dark p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">2. Reference Material</h3>
                                             <span class="px-2 py-1 rounded text-xs font-medium bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400">Optional</span>                </div>
                <div id="pdf-drop-area" class="flex-1 flex flex-col items-center justify-center gap-4 rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 group-hover:border-primary/50 bg-slate-50 dark:bg-[#141e28] px-6 py-10 transition-colors cursor-pointer">
                    <div class="size-12 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400 mb-2">
                        <span class="material-symbols-outlined text-3xl">picture_as_pdf</span>
                    </div>
                    <div class="text-center space-y-1 max-w-full">
                                <p id="pdf-status" class="text-slate-900 dark:text-white font-semibold truncate">Upload Reference PDF</p>
                                <p class="text-slate-500 dark:text-slate-400 text-sm">Drag & drop or click to browse</p>
                            </div>                </div>
                 <input type="file" id="file-pdf" accept=".pdf" class="hidden" onchange="handlePdfUpload(this)">
            </div>
        </div>

        <div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-lg border border-border-light dark:border-border-dark p-6 flex flex-col md:flex-row gap-6 items-center justify-between">
            <div id="summary-panel" class="flex-1 w-full space-y-2 hidden">
                <h3 class="text-sm font-bold uppercase tracking-wider text-slate-400 dark:text-slate-500">Session Summary</h3>
                <div class="flex flex-wrap gap-4 pt-2">
                    <div class="flex items-center gap-2 text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-800 px-3 py-1.5 rounded-lg">
                        <span class="material-symbols-outlined text-lg">quiz</span>
                        <span id="summary-questions" class="text-sm font-medium">-- Questions</span>
                    </div>
                    <div class="flex items-center gap-2 text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-800 px-1 py-1 rounded-lg">
                        <span class="material-symbols-outlined text-lg pl-2">timer</span>
                        <button onclick="adjustTime(-5)" class="size-7 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 font-mono text-lg">-</button>
                        <span id="summary-time" class="text-sm font-medium w-24 text-center tabular-nums">-- Minutes</span>
                        <button onclick="adjustTime(5)" class="size-7 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 font-mono text-lg">+</button>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-auto flex flex-col gap-3 min-w-[240px]">
                <button id="btn-start-app" onclick="startApp()" disabled class="w-full h-12 bg-primary hover:bg-blue-600 active:bg-blue-700 text-white font-bold text-lg rounded-xl shadow-md shadow-blue-500/20 transition-all flex items-center justify-center gap-2 group disabled:bg-slate-300 dark:disabled:bg-slate-700 disabled:shadow-none disabled:cursor-not-allowed">
                    <span>Start Quiz</span>
                    <span class="material-symbols-outlined group-hover:translate-x-1 transition-transform">arrow_forward</span>
                </button>
                <button onclick="toggleInstructions(true)" class="text-sm text-primary hover:underline mt-4 text-center w-full">How to Generate Quiz JSON?</button>
            </div>
        </div>
    </div>
</div>


<!-- INSTRUCTIONS MODAL -->
<div id="instructions-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
    <div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
        <header class="flex items-center justify-between p-4 border-b border-border-light dark:border-border-dark">
            <h2 class="text-xl font-bold">How to Generate Quiz JSON</h2>
            <button onclick="toggleInstructions(false)" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800">
                <span class="material-symbols-outlined">close</span>
            </button>
        </header>
        <div class="flex-1 p-6 space-y-6 overflow-y-auto custom-scrollbar">
            <div class="prose prose-slate dark:prose-invert max-w-none">
                <p>To generate the required JSON data for this application, you can use any advanced AI model. Follow these steps:</p>
                <ol>
                    <li>Open your preferred AI assistant:
                        <ul class="list-disc pl-5 mt-1 mb-2">
                            <li><a href="https://chatgpt.com/" target="_blank" class="text-primary hover:underline">ChatGPT</a> (OpenAI)</li>
                            <li><a href="https://claude.ai/" target="_blank" class="text-primary hover:underline">Claude</a> (Anthropic)</li>
                            <li><a href="https://gemini.google.com/" target="_blank" class="text-primary hover:underline">Gemini</a> / <a href="https://aistudio.google.com/" target="_blank" class="text-primary hover:underline">AI Studio</a> (Google)</li>
                        </ul>
                    </li>
                    <li>Copy the complete system prompt provided below.</li>
                    <li>Paste it into the chat.</li>
                    <li>Upload your PDF quiz file (or paste the text content).</li>
                    <li>The AI will generate the JSON output.</li>
                    <li>Copy the entire JSON output (starting with <code>[</code> and ending with <code>]</code>).</li>
                    <li>Return to this page and paste the JSON into the text box on the setup screen.</li>
                </ol>
            </div>

            <div>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-lg">System Prompt</h3>
                    <button onclick="copyPromptToClipboard()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-sm font-medium">
                        <span class="material-symbols-outlined text-base">content_copy</span>
                        Copy
                    </button>
                </div>
                <pre id="system-prompt-content" class="bg-slate-100 dark:bg-background-dark p-4 rounded-lg border border-border-light dark:border-border-dark text-sm max-h-96 overflow-y-auto custom-scrollbar whitespace-pre-wrap font-mono"></pre>
            </div>
        </div>
    </div>
</div>


<!-- APP CONTAINER -->
<div id="app-interface" class="h-screen flex-col overflow-hidden hidden">
    <!-- Header -->
    <header class="flex-none h-16 bg-surface-light dark:bg-slate-900 border-b border-border-light dark:border-border-dark flex items-center justify-between px-4 lg:px-8 z-20 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="size-8 bg-primary/10 rounded flex items-center justify-center text-primary">
                <span class="material-symbols-outlined">school</span>
            </div>
            <div>
                <h1 class="text-base lg:text-lg font-bold leading-tight">Quiz Master</h1>
                <p id="progress-text" class="text-xs text-slate-500 dark:text-slate-400">Question 1 of --</p>
            </div>
        </div>
        <div class="flex items-center gap-3 lg:gap-6">
            <div class="flex flex-col items-end">
                <div id="timer" class="flex items-center gap-2 text-slate-900 dark:text-white font-mono font-bold text-lg">
                    <span class="material-symbols-outlined text-slate-400">timer</span>
                    <span>00:00</span>
                </div>
                <span class="text-[10px] font-medium text-emerald-600 dark:text-emerald-400 uppercase tracking-wider">Time Remaining</span>
            </div>
            <div class="h-8 w-px bg-slate-200 dark:bg-slate-700 mx-2 hidden sm:block"></div>
            <button onclick="togglePdfPanel()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 text-sm font-medium rounded-lg transition-colors">
                <span class="material-symbols-outlined text-[20px]">menu_book</span>
                <span id="pdf-btn-text" class="hidden sm:inline">Reference</span>
            </button>
            <button onclick="toggleGrid()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 text-sm font-medium rounded-lg transition-colors">
                 <span class="material-symbols-outlined text-[20px]">grid_view</span>
                <span class="hidden sm:inline">Grid</span>
            </button>
            <button id="theme-toggle-btn" onclick="toggleTheme()" class="flex items-center justify-center size-10 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 transition-colors">
                <span id="theme-icon" class="material-symbols-outlined">dark_mode</span>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-content-area" class="flex flex-1 overflow-hidden relative">
        <div class="flex-1 flex flex-col h-full overflow-hidden relative z-10 transition-all duration-300 ease-in-out">
            <div class="h-1 w-full bg-slate-200 dark:bg-slate-800">
                <div id="progress-bar" class="h-full bg-primary rounded-r transition-all duration-500" style="width: 0%"></div>
            </div>
            <div id="quiz-content" class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-10 pb-24">
                <!-- Dynamic Content -->
            </div>
            <footer class="flex-none bg-surface-light dark:bg-slate-900 border-t border-border-light dark:border-border-dark p-4 lg:px-8 flex flex-wrap justify-between items-center gap-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
                <button onclick="nav(-1)" class="flex items-center gap-2 px-4 py-2 sm:px-6 sm:py-3 rounded-lg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 font-bold text-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors disabled:opacity-50">
                    <span class="material-symbols-outlined text-[18px]">arrow_back</span> <span class="hidden xs:inline">Previous</span><span class="xs:hidden">Prev</span>
                </button>
                <button onclick="submitTest()" class="flex items-center gap-2 px-6 py-2 sm:px-8 sm:py-3 rounded-lg bg-primary hover:bg-blue-600 text-white font-bold text-sm shadow-lg shadow-blue-500/20 transition-all">
                    Submit <span class="hidden sm:inline">Quiz</span>
                </button>
                <button onclick="nav(1)" class="flex items-center gap-2 px-4 py-2 sm:px-6 sm:py-3 rounded-lg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 font-bold text-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors disabled:opacity-50">
                    <span class="hidden xs:inline">Next</span><span class="xs:hidden">Next</span> <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
                </button>
            </footer>
        </div>
        <div id="splitter" class="w-2 cursor-col-resize bg-slate-200 dark:bg-slate-700 hover:bg-primary/50 transition-colors"></div>
            <aside class="pdf-viewer w-[45%] bg-slate-100 dark:bg-[#0d141c] border-l border-border-light dark:border-border-dark flex-col h-full shadow-xl z-20 hidden lg:flex">
             <div class="flex items-center justify-between px-4 py-2 bg-surface-light dark:bg-surface-dark border-b border-border-light dark:border-border-dark shadow-sm z-10">
                <h3 class="font-bold text-slate-900 dark:text-white">Reference Material</h3>
<div class="flex items-center gap-2">
                        <div class="flex items-center bg-slate-100 dark:bg-slate-800 rounded-md p-0.5">
                            <button onclick="changePdfPage(-1)" class="p-1.5 hover:bg-white dark:hover:bg-slate-700 rounded text-slate-500 dark:text-slate-400" title="Previous Page"><span class="material-symbols-outlined text-sm">keyboard_arrow_up</span></button>
                            <span id="pdf-page-num" class="px-2 text-xs font-mono font-medium text-slate-700 dark:text-slate-300">1 / --</span>
                            <button onclick="changePdfPage(1)" class="p-1.5 hover:bg-white dark:hover:bg-slate-700 rounded text-slate-500 dark:text-slate-400" title="Next Page"><span class="material-symbols-outlined text-sm">keyboard_arrow_down</span></button>
                        </div>
                        <div class="h-4 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>
                        <button onclick="zoomPdf(-0.2)" class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded text-slate-500 dark:text-slate-400" title="Zoom Out"><span class="material-symbols-outlined text-lg">remove</span></button>
                        <button onclick="zoomPdf(0.2)" class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded text-slate-500 dark:text-slate-400" title="Zoom In"><span class="material-symbols-outlined text-lg">add</span></button>
                        <div class="h-4 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>
                        <button onclick="fitPdf()" class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded text-slate-500 dark:text-slate-400" title="Fit to Width"><span class="material-symbols-outlined text-lg">fit_screen</span></button>
                    </div>
                </div>
                <div id="pdf-render-container" class="flex-1 overflow-auto custom-scrollbar p-6 flex justify-center">
                     <canvas id="the-canvas" class="max-w-none bg-white min-h-[1000px] shadow-lg rounded-sm"></canvas>
                </div>
            </aside>
        </div>
    </div>
</main>


<!-- INSTRUCTIONS MODAL -->
<div id="results-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
    <div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col">
        <header class="flex items-center justify-between p-4 border-b border-border-light dark:border-border-dark">
            <h2 class="text-xl font-bold">Results Summary</h2>
            <button onclick="document.getElementById('results-modal').style.display = 'none'" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800">
                <span class="material-symbols-outlined">close</span>
            </button>
        </header>
        <div class="flex flex-1 min-h-0">
            <div id="results-list" class="w-1/2 overflow-y-auto custom-scrollbar p-6 space-y-4 border-r border-border-light dark:border-border-dark">
                <!-- Scrollable list of answers goes here -->
            </div>
            <div class="results-pdf-panel w-1/2 bg-slate-100 dark:bg-background-dark flex items-start justify-center overflow-auto custom-scrollbar p-6">
                <canvas id="results-pdf-canvas" class="shadow-lg"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- GRID MODAL -->
<div id="grid-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
    <div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-2xl w-full max-w-2xl flex flex-col">
        <header class="flex items-center justify-between p-4 border-b border-border-light dark:border-border-dark">
            <h3 class="font-bold text-slate-900 dark:text-white">Question Navigator</h3>
             <button onclick="toggleGrid()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800">
                <span class="material-symbols-outlined">close</span>
            </button>
        </header>
        <div class="p-4">
            <div class="flex flex-wrap gap-2 text-xs mb-4">
                <div class="flex items-center gap-1.5"><div class="size-2.5 rounded-full bg-emerald-500"></div><span class="text-slate-600 dark:text-slate-400">Answered</span></div>
                <div class="flex items-center gap-1.5"><div class="size-2.5 rounded-full bg-slate-300 dark:bg-slate-600"></div><span class="text-slate-600 dark:text-slate-400">Unanswered</span></div>
                <div class="flex items-center gap-1.5"><div class="size-2.5 rounded-full bg-amber-400"></div><span class="text-slate-600 dark:text-slate-400">Flagged</span></div>
                 <div class="flex items-center gap-1.5"><div class="size-2.5 rounded-full ring-2 ring-primary"></div><span class="text-slate-600 dark:text-slate-400">Current</span></div>
            </div>
        </div>
        <div id="grid-content" class="p-4 grid grid-cols-10 gap-2 overflow-y-auto custom-scrollbar"></div>
    </div>
</div>


<script>
// --- APP STATE ---
let quizData = [];
let pdfDoc = null;
let renderTask = null;
let currentQIndex = 0;
let answers = [];
let flagged = [];
let timeLeft = 0;
let endTime = 0;
let timerInterval;
let pdfScale = 1.5;
let isPdfVisible = false;
let quizDurationInMinutes = 0;
let isInitialPdfRender = true;

const setupScreen = document.getElementById('setup-screen');
const appInterface = document.getElementById('app-interface');
const jsonDropArea = document.getElementById('json-drop-area');
const pdfDropArea = document.getElementById('pdf-drop-area');
const jsonPaste = document.getElementById('json-paste');
const jsonFileInput = document.getElementById('file-json');
const pdfFileInput = document.getElementById('file-pdf');
const instructionsModal = document.getElementById('instructions-modal');
const systemPromptContent = document.getElementById('system-prompt-content');

const systemPromptText = `You are an autonomous Quiz Digitization Engine. Your purpose is to convert PDF documents containing questions, images, and answer keys into a strictly formatted, error-free JSON dataset for a web application.

Your final output should be a single, complete JSON array. Avoid any conversational text, headers, or explanations outside of the JSON structure itself. The output should begin with \`[\` and end with \`]\`.

### 1. PROCESSING ALGORITHM
You will execute the following logic sequentially:
1.  **Full Scan:** Read the entire document from start to finish. Identify the structure: usually Questions first, followed by a separate "Solutions" or "Explanations" section at the end.
2.  **Mapping:** Logically link every Question Number (e.g., Q1, Q2) with its corresponding Option list, Correct Answer, and Detailed Explanation from the answer key section.
3.  **Image Detection:** Visually scan the area immediately surrounding a question. If an image (diagram, chart, photo) is present, assign a placeholder filename.
4.  **Sanitization:** Strip page numbers, headers, and watermarks. Fix obvious OCR typos.
5.  **JSON Construction:** Apply specific formatting rules to the extracted data.

### 2. DATA SCHEMA RULES
You must construct an array of objects. Each object must strictly adhere to this schema:

- \`text\`: (String) The question stem. Preserve line breaks if necessary using \`<br>\`.
- \`options\`: (Array of Objects) Exactly 4 options (or as many as present).
    - \`label\`: "A", "B", "C", "D", etc.
    - \`text\`: The content of the option.
    - \`correct\`: (Boolean) \`true\` if this is the correct answer, \`false\` otherwise.
- \`correct_answer\`: (String) The option label and text (e.g., "B. Paris").
- \`explanation\`: (String) The detailed explanation from the PDF.
    - **CRITICAL:** You must format this string as HTML.
    - Use \`<strong>\` for key concepts.
    - Use \`<ul><li>\` for bullet points.
    - Use \`<br>\` for line breaks.
    - Do NOT use markdown (**bold**) inside the JSON string; use HTML tags (\`<b>bold</b>\`).
- \`page_ref\`: (Integer) **CRITICAL FIELD.** The specific PDF Page Number where the **ANSWER AND EXPLANATION** for this question are located. This is for verification. If the PDF starts at physical page 1, use 1-based indexing.
- \`question_images\`: (Array of Strings) 
    - If an image is present for the question, output: \`["image_Q{number}.png"]\` (e.g., \`["image_Q15.png"]\`). 
    - If multiple images exist, list them all. 
    - If NO image exists, output \`[]\`.
- \`explanation_images\`: (Array of Strings) Same logic as above, but for images found inside the explanation section.

### 3. EDGE CASE HANDLING
- **Missing Explanation:** If the PDF only gives the answer key (e.g., "1. B") without text, generate a concise explanation based on your internal knowledge to justify the answer.
- **Image-Based Options:** If the options are images (e.g., "Option A is Image A"), set the option text to "(See Image A)" and ensure \`image_Q{n}.png\` is included in the \`question_images\` array.
- **Combined Questions:** If a single image serves Q4 and Q5, include the same image placeholder \`["image_Q4_Q5.png"]\` for both JSON entries.
- **Quote Escaping:** If the text contains double quotes ("), you MUST escape them (e.g., \`\\"patient stated...\\"\`) to prevent breaking the JSON syntax.

### 4. OUTPUT TEMPLATE
Your output must look EXACTLY like this structure:

[
  {
    "text": "What is the capital city of France?",
    "options": [
      { "label": "A", "text": "London", "correct": false },
      { "label": "B", "text": "Paris", "correct": true },
      { "label": "C", "text": "Berlin", "correct": false },
      { "label": "D", "text": "Madrid", "correct": false }
    ],
    "correct_answer": "B. Paris",
    "question_images": [],
    "explanation_images": [],
    "explanation": "<p><strong>Correct Answer: B.</strong><br>Paris is the capital and most populous city of France.</p>",
    "page_ref": 5
  }
]

Begin processing immediately. Process ALL questions found in the document.`;
systemPromptContent.textContent = systemPromptText;


function toggleInstructions(show) {
    if (show) {
        instructionsModal.style.display = 'flex';
    } else {
        instructionsModal.style.display = 'none';
    }
}

function copyPromptToClipboard() {
    navigator.clipboard.writeText(systemPromptText).then(() => {
        alert('System prompt copied to clipboard!');
    }, (err) => {
        alert('Failed to copy text.');
        console.error('Async: Could not copy text: ', err);
    });
}


// --- DRAG, DROP, CLICK HANDLERS ---
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  jsonDropArea.addEventListener(eventName, preventDefaults, false);
  pdfDropArea.addEventListener(eventName, preventDefaults, false);
});
['dragenter', 'dragover'].forEach(eventName => {
    jsonDropArea.addEventListener(eventName, () => jsonDropArea.classList.add('border-primary'), false);
    pdfDropArea.addEventListener(eventName, () => pdfDropArea.classList.add('border-primary'), false);
});
['dragleave', 'drop'].forEach(eventName => {
    jsonDropArea.addEventListener(eventName, () => jsonDropArea.classList.remove('border-primary'), false);
    pdfDropArea.addEventListener(eventName, () => pdfDropArea.classList.remove('border-primary'), false);
});
jsonDropArea.addEventListener('drop', handleJsonDrop, false);
pdfDropArea.addEventListener('drop', handlePdfDrop, false);
jsonDropArea.addEventListener('click', () => jsonFileInput.click());
pdfDropArea.addEventListener('click', () => pdfFileInput.click());

function preventDefaults (e) {
  e.preventDefault();
  e.stopPropagation();
}

function handleJsonDrop(e) {
  let dt = e.dataTransfer;
  let file = dt.files[0];
  handleJsonFile(file);
}

function handlePdfDrop(e) {
  let dt = e.dataTransfer;
  let file = dt.files[0];
  handlePdfFile(file);
}

function handleJsonPaste() {
    const textarea = document.getElementById('json-paste');
    const value = textarea.value.trim();
    if (!value) {
        updateStatus('json-status', 'Or Upload a File', 'neutral'); 
        return;
    }
    try {
        quizData = JSON.parse(value);
        updateStatus('json-status', `Parsed ${quizData.length} Qs from text`, 'success');
        
        quizDurationInMinutes = quizData.length * 2;
        document.getElementById('summary-time').textContent = `${quizDurationInMinutes} Minutes`;
        
        checkReady();
    } catch(err) {
        updateStatus('json-status', 'Invalid JSON in text area!', 'error');
    }
}

// --- SETUP HANDLERS ---
function handleJsonUpload(input) {
    if (input.files.length > 0) handleJsonFile(input.files[0]);
}

function handleJsonFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            quizData = JSON.parse(e.target.result);
            updateStatus('json-status', `Loaded: ${file.name}`, 'success');
            document.getElementById('json-paste').value = e.target.result; // reflect in text area
            
            quizDurationInMinutes = quizData.length * 2;
            document.getElementById('summary-time').textContent = `${quizDurationInMinutes} Minutes`;

            checkReady();
        } catch(err) { updateStatus('json-status', "Invalid JSON file", 'error'); }
    };
    reader.readAsText(file);
}


function handlePdfUpload(input) {
    if (input.files.length > 0) handlePdfFile(input.files[0]);
}

function handlePdfFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const typedarray = new Uint8Array(e.target.result);
        pdfjsLib.getDocument(typedarray).promise.then((pdf) => {
            pdfDoc = pdf;
            updateStatus('pdf-status', `Loaded: ${file.name} (${pdf.numPages} Pages)`, 'success');
            checkReady();
        });
    };
    reader.readAsArrayBuffer(file);
}

function updateStatus(elementId, message, statusType) {
    const statusEl = document.getElementById(elementId);
    statusEl.textContent = message;
    
    const colors = {
        success: 'text-green-600 dark:text-green-400',
        error: 'text-red-600 dark:text-red-400',
        neutral: 'text-slate-900 dark:text-white'
    };
    
    statusEl.classList.remove('text-green-600', 'dark:text-green-400', 'text-red-600', 'dark:text-red-400', 'text-slate-900', 'dark:text-white');
    statusEl.classList.add(...(colors[statusType] || colors.neutral).split(' '));
}

function checkReady() {
    const btn = document.getElementById('btn-start-app');
    // PDF is now optional
    if (quizData.length > 0) {
        btn.disabled = false;
        document.getElementById('summary-questions').textContent = `${quizData.length} Questions`;
        document.getElementById('summary-panel').style.display = 'block';
    }
}

function adjustTime(minutes) {
    quizDurationInMinutes += minutes;
    if (quizDurationInMinutes < 5) {
        quizDurationInMinutes = 5; // Minimum 5 minutes
    }
    document.getElementById('summary-time').textContent = `${quizDurationInMinutes} Minutes`;
}

function saveProgress() {
    const data = {
        answers,
        flagged,
        timeLeft,
        currentQIndex,
        quizLength: quizData.length,
        timestamp: Date.now()
    };
    try {
        localStorage.setItem('quiz_master_save', JSON.stringify(data));
    } catch(e) { console.warn('Autosave failed', e); }
}

function startApp() {
    setupScreen.style.display = 'none';
    document.getElementById('landing-header').style.display = 'none'; // Hide landing header
    appInterface.style.display = 'block'; // Changed to block to respect flex container
    
    // Prevent accidental reload
    window.onbeforeunload = function() {
        return "Are you sure you want to leave? Your exam progress will be lost.";
    };
    
    // Hide PDF button if no PDF is loaded
    if (!pdfDoc) {
        document.querySelector('[onclick="togglePdfPanel()"]').style.display = 'none';
        document.getElementById('main-content-area').classList.add('full-width');
        isPdfVisible = false;
    } else {
        isPdfVisible = true;
        document.getElementById('pdf-btn-text').textContent = "Hide Reference";
        document.getElementById('main-content-area').classList.add('pdf-viewer-visible');
    }

    answers = new Array(quizData.length).fill(null);
    flagged = new Array(quizData.length).fill(false);
    timeLeft = quizDurationInMinutes * 60;
    currentQIndex = 0; // Reset index to start

    // Check for saved session
    try {
        const saved = localStorage.getItem('quiz_master_save');
        if (saved) {
            const data = JSON.parse(saved);
            // Simple validation: same number of questions
            if (data.quizLength === quizData.length) {
                if (confirm("Found a saved session. Do you want to resume?")) {
                    answers = data.answers;
                    flagged = data.flagged;
                    timeLeft = data.timeLeft;
                    currentQIndex = data.currentQIndex;
                } else {
                    localStorage.removeItem('quiz_master_save');
                }
            }
        }
    } catch(e) { console.warn('Restore failed', e); }
    
    startTimer();
    renderQuestion();
}

// --- CORE QUIZ FUNCTIONS ---
function renderQuestion() {
    if (!quizData || quizData.length === 0) return;
    const q = quizData[currentQIndex];
    if (!q) return;

    const container = document.getElementById('quiz-content');
    
    // Save focus before re-render
    const activeElementId = document.activeElement ? document.activeElement.id : null;
    
    document.getElementById('progress-text').innerText = `Question ${currentQIndex + 1} of ${quizData.length}`;
    document.getElementById('progress-bar').style.width = `${((currentQIndex + 1) / quizData.length) * 100}%`;
    
    if(isPdfVisible) {
        if (isInitialPdfRender) {
             // Use fitPdf() for the first render to auto-scale
             // Use setTimeout to ensure layout is complete after display:block
             setTimeout(() => {
                 fitPdf();
                 isInitialPdfRender = false;
             }, 50);
        } else {
            renderPdfPage(q.page_ref);
        }
    }

    let optionsHtml = q.options.map((opt, idx) => {
        const label = opt.label || String.fromCharCode(65 + idx);
        const text = opt.text || opt;
        const isSelected = answers[currentQIndex] === label;
        const inputId = `opt-${currentQIndex}-${idx}`; // Unique ID for focus tracking
        
        return `
            <label class="flex group cursor-pointer relative">
                <input type="radio" id="${inputId}" name="question${currentQIndex}" class="peer sr-only" onchange="selectAnswer('${label}')" ${isSelected ? 'checked' : ''}/>
                <div class="w-full p-4 lg:p-5 rounded-lg border-2 border-slate-200 dark:border-slate-700 bg-surface-light dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 peer-checked:border-primary peer-checked:bg-primary/5 dark:peer-checked:bg-primary/10 transition-all flex items-start gap-4">
                    <div class="flex-none size-6 rounded-full border-2 border-slate-300 dark:border-slate-500 peer-checked:border-primary peer-checked:bg-primary transition-all mt-1"></div>
                    <div class="flex-1">
                        <span class="font-bold text-slate-900 dark:text-white mr-2">${label}.</span>
                        <span class="text-slate-700 dark:text-slate-300">${text}</span>
                    </div>
                </div>
            </label>
        `;
    }).join('');

    const isFlagged = flagged[currentQIndex];

    container.innerHTML = `
        <div class="max-w-4xl mx-auto w-full">
            <div class="flex items-center justify-between mb-6">
                <span class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide">Question ${currentQIndex + 1} of ${quizData.length}</span>
                <button onclick="toggleFlagForReview()" class="group flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/40 transition-colors ${isFlagged ? 'text-amber-500' : 'text-slate-500 dark:text-slate-400'}">
                    <span class="material-symbols-outlined text-lg transition-all ${isFlagged ? 'font-bold' : ''}" style="font-variation-settings: 'FILL' ${isFlagged ? 1 : 0}">flag</span>
                    <span class="text-sm font-medium">${isFlagged ? 'Remove Flag' : 'Flag for Review'}</span>
                </button>
            </div>
            <div class="bg-surface-light dark:bg-slate-800 rounded-xl shadow-sm border border-border-light dark:border-border-dark p-6 lg:p-8 mb-8">
                <h2 class="text-xl lg:text-2xl font-medium leading-relaxed text-slate-900 dark:text-white mb-6">${q.text}</h2>
                <div class="space-y-3">${optionsHtml}</div>
            </div>
        </div>
    `;

    // Restore focus if applicable
    if (activeElementId) {
        const el = document.getElementById(activeElementId);
        if (el) el.focus();
    }
}


function selectAnswer(label) {
    answers[currentQIndex] = label;
    saveProgress();
    renderQuestion();
}

function toggleFlagForReview() {
    flagged[currentQIndex] = !flagged[currentQIndex];
    saveProgress();
    renderQuestion();
}

function nav(dir) {
    const newIdx = currentQIndex + dir;
    if(newIdx >= 0 && newIdx < quizData.length) {
        currentQIndex = newIdx;
        saveProgress();
        renderQuestion();
    }
}

// --- PDF ENGINE ---
function togglePdfPanel(forceState) {
    const mainArea = document.getElementById('main-content-area');
    const btnText = document.getElementById('pdf-btn-text');
    
    isPdfVisible = forceState !== undefined ? forceState : !isPdfVisible;

    if(isPdfVisible) {
        mainArea.classList.remove('full-width');
        mainArea.classList.add('pdf-viewer-visible');
        btnText.textContent = "Hide Reference";
        renderPdfPage(quizData[currentQIndex]?.page_ref);
    } else {
        mainArea.classList.add('full-width');
        mainArea.classList.remove('pdf-viewer-visible');
        btnText.textContent = "Show Reference";
    }
}


function renderPdfPage(num) {
    if(!pdfDoc) return;
    
    const canvas = document.getElementById('the-canvas');
    const ctx = canvas.getContext('2d');

    if (!num) {
        // Clear canvas if no page number provided
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('pdf-page-num').innerText = "- / -";
        if (renderTask) {
            renderTask.cancel();
            renderTask = null;
        }
        return;
    }
    
    document.getElementById('pdf-page-num').innerText = `${num} / ${pdfDoc.numPages}`;
    
    // Reset scroll position
    const container = document.getElementById('pdf-render-container');
    if (container) {
        container.scrollTop = 0;
        container.scrollLeft = 0;
    }

    pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({scale: pdfScale});
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        if (renderTask) {
            renderTask.cancel();
        }

        renderTask = page.render({ canvasContext: ctx, viewport: viewport });
        
        renderTask.promise.then(() => {
            renderTask = null;
        }).catch(err => {
            if (err.name !== 'RenderingCancelledException') {
                console.error(err);
            }
        });
    });
}

function changePdfPage(dir) {
    const currentText = document.getElementById('pdf-page-num').innerText;
    let currentNum = parseInt(currentText.split(' / ')[0]);
    if(!currentNum) currentNum = 1; // Default to 1 if invalid, but maybe should check if we have a valid page first? 
    // Actually, if we are on "- / -", currentNum is NaN.
    if (isNaN(currentNum)) currentNum = 0;
    
    const newNum = currentNum + dir;
    if(newNum >= 1 && newNum <= pdfDoc.numPages) {
        renderPdfPage(newNum);
    }
}

function zoomPdf(amount) {
    let newScale = pdfScale + amount;
    // Proper clamping to fix boundary issues
    newScale = Math.max(0.5, Math.min(3.0, newScale));
    
    // Only update if scale changed significantly
    if (Math.abs(newScale - pdfScale) > 0.001) {
        pdfScale = newScale;
        
        const currentText = document.getElementById('pdf-page-num').innerText;
        let currentPageNum = parseInt(currentText.split(' / ')[0]);

        if (isNaN(currentPageNum) || currentPageNum < 1) {
            currentPageNum = quizData[currentQIndex]?.page_ref;
        }

        if (pdfDoc) {
             renderPdfPage(currentPageNum); // Pass currentPageNum even if undefined (will clear)
        }
    }
}

function fitPdf() {
    if (!pdfDoc) return;
    const container = document.getElementById('pdf-render-container');
    
    // Get valid page number to calculate dimensions
    const currentText = document.getElementById('pdf-page-num').innerText;
    let pageNum = parseInt(currentText.split(' / ')[0]);
    if (isNaN(pageNum) || pageNum < 1) pageNum = quizData[currentQIndex]?.page_ref || 1;

    pdfDoc.getPage(pageNum).then(page => {
        const viewport = page.getViewport({scale: 1});
        // Calculate scale to fit width minus padding (48px = 3rem approx)
        const containerWidth = container.clientWidth - 48;
        if (containerWidth > 0) {
            let newScale = containerWidth / viewport.width;
            // Clamp
            newScale = Math.max(0.5, Math.min(3.0, newScale));
            pdfScale = newScale;
            renderPdfPage(pageNum); // Re-render current page
        }
    });
}

// --- GRID & UTILS ---
function toggleGrid() {
    const modal = document.getElementById('grid-modal');
    if(modal.style.display === 'flex') {
        modal.style.display = 'none';
        return;
    }
    
    const content = document.getElementById('grid-content');
    content.innerHTML = quizData.map((_, i) => {
        let cls = 'aspect-square flex items-center justify-center rounded font-medium text-sm transition-colors border ';
        if (flagged[i]) {
            cls += 'bg-amber-100 text-amber-700 hover:bg-amber-200 dark:bg-amber-900/30 dark:text-amber-400 border-transparent relative';
        } else if (answers[i]) {
            cls += 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 border-transparent';
        } else {
            cls += 'bg-slate-200 text-slate-600 hover:bg-slate-300 dark:bg-slate-800 dark:text-slate-400 border-transparent';
        }
        if (i === currentQIndex) {
            cls += ' ring-2 ring-primary';
        }
        
        return `<button onclick="jumpTo(${i})" class="${cls}">${i+1}</button>`;
    }).join('');
    modal.style.display = 'flex';
}

function jumpTo(i) {
    currentQIndex = i;
    toggleGrid();
    renderQuestion();
}

function startTimer() {
    const timerEl = document.getElementById('timer').querySelector('span:last-child');
    endTime = Date.now() + (timeLeft * 1000);

    timerInterval = setInterval(() => {
        const now = Date.now();
        const remaining = Math.max(0, Math.ceil((endTime - now) / 1000));
        
        timeLeft = remaining;

        let m = Math.floor(remaining / 60).toString().padStart(2,'0');
        let s = (remaining % 60).toString().padStart(2,'0');
        timerEl.innerText = `${m}:${s}`;
        
        if(remaining < 300) { // 5 minutes
             document.getElementById('timer').classList.add('text-red-500');
        } else {
             document.getElementById('timer').classList.remove('text-red-500');
        }
        
        if (remaining % 5 === 0) saveProgress(); // Autosave every 5 seconds

        if(remaining <= 0) {
            submitTest(true);
        }
    }, 1000);
}

// --- THEME TOGGLE ---
function toggleTheme() {
    const htmlEl = document.documentElement;
    const isDark = htmlEl.classList.toggle('dark');

    try {
        if (isDark) {
            localStorage.theme = 'dark';
        } else {
            localStorage.theme = 'light';
        }
    } catch(e) {}
    setInitialThemeIcon(); // Update all icons
}

function setInitialThemeIcon() {
    const isDark = document.documentElement.classList.contains('dark');
    const iconValue = isDark ? 'light_mode' : 'dark_mode';

    const appThemeIcon = document.getElementById('theme-icon');
    if (appThemeIcon) appThemeIcon.textContent = iconValue;

    const setupThemeIcon = document.getElementById('setup-theme-icon');
    if (setupThemeIcon) setupThemeIcon.textContent = iconValue;
}
setInitialThemeIcon();

// --- RESIZABLE SPLITTER ---
makeResizable(document.getElementById('main-content-area'));

function makeResizable(panel) {
    const splitter = document.getElementById('splitter');
    const mainContent = panel.querySelector('.flex-1');
    const pdfViewer = panel.querySelector('.pdf-viewer');

    let isDragging = false;

    splitter.addEventListener('mousedown', function(e) {
        e.preventDefault();
        isDragging = true;
        document.body.style.cursor = 'col-resize';
        mainContent.style.pointerEvents = 'none';
        pdfViewer.style.pointerEvents = 'none';

        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
    });

    function onMouseMove(e) {
        if (!isDragging) return;
        const totalWidth = panel.offsetWidth;
        const newPdfWidth = totalWidth - e.clientX;
        
        const pdfPercentage = (newPdfWidth / totalWidth) * 100;

        if (pdfPercentage > 20 && pdfPercentage < 80) {
            pdfViewer.style.width = `${pdfPercentage}%`;
            mainContent.style.width = `${100 - pdfPercentage}%`;
        }
    }

    function onMouseUp() {
        isDragging = false;
        document.body.style.cursor = 'default';
        mainContent.style.pointerEvents = 'auto';
        pdfViewer.style.pointerEvents = 'auto';

        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);
    }
}


// --- KEYBOARD NAVIGATION ---
window.addEventListener('keydown', handleKeyDown);

function handleKeyDown(e) {
    // Don't interfere with modals
    if (document.getElementById('results-modal').style.display === 'flex' || document.getElementById('grid-modal').style.display === 'flex') {
        if (e.key === 'Escape') {
            document.getElementById('results-modal').style.display = 'none';
            document.getElementById('grid-modal').style.display = 'none';
        }
        return;
    }
     // Don't interfere with setup
    if (setupScreen.style.display !== 'none') return;

    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    if (e.key === 'ArrowLeft') nav(-1);
    if (e.key === 'ArrowRight' || e.key === 'Enter') nav(1);
    
    if (e.key.toUpperCase() >= 'A' && e.key.toUpperCase() <= 'Z') {
        const q = quizData[currentQIndex];
        const optionIndex = e.key.toUpperCase().charCodeAt(0) - 'A'.charCodeAt(0);
        if (q && q.options && optionIndex < q.options.length) {
            const label = q.options[optionIndex].label || String.fromCharCode(65 + optionIndex);
            selectAnswer(label);
        }
    }
    
    if (e.key.toLowerCase() === 'g') toggleGrid();
    if (e.key.toLowerCase() === 'r') togglePdfPanel();
    if (e.key.toLowerCase() === 'f') toggleFlagForReview();
    if (e.key.toLowerCase() === 's') submitTest();
}

// --- RESULTS ---
function submitTest(force = false) {
    if (!force && timeLeft > 0) {
        if (!confirm("Are you sure you want to submit the exam?")) return;
    }
    clearInterval(timerInterval);
    localStorage.removeItem('quiz_master_save'); // Clear save
    const modal = document.getElementById('results-modal');
    const list = document.getElementById('results-list');
    const resultsPdfPanel = modal.querySelector('.results-pdf-panel');
    
    // Ensure resultsPdfPanel is found before accessing style
    if (resultsPdfPanel) {
        if (!pdfDoc) {
            resultsPdfPanel.style.display = 'none';
            list.style.width = '100%';
            list.classList.remove('w-1/2'); // Remove w-1/2 if present
            list.classList.add('w-full');   // Ensure full width
        } else {
            resultsPdfPanel.style.display = 'flex';
            list.style.width = '50%';
            list.classList.remove('w-full');
            list.classList.add('w-1/2');
        }
    }
    
    let correctCount = 0;
    let firstIncorrectPage = null;
    let firstIncorrectElement;

    list.innerHTML = quizData.map((q, i) => {
        const correctLabel = q.correct_answer;
        const isCorrect = answers[i] === correctLabel;
        if(isCorrect) correctCount++;
        else if (!firstIncorrectPage) firstIncorrectPage = q.page_ref;
        
        const statusClass = isCorrect ? 'correct' : 'incorrect';
        const statusColor = isCorrect ? 'text-emerald-500' : 'text-red-500';
        
        return `
        <div class="result-item p-4 rounded-lg border border-border-light dark:border-border-dark cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/50 ${statusClass}" onclick="renderResultsPdfPage(${q.page_ref || null}, this)">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <p class="font-bold">Question ${i+1}</p>
                    ${flagged[i] ? '<span class="material-symbols-outlined text-amber-500 text-base" style="font-variation-settings: \'FILL\' 1">flag</span>' : ''}
                </div>
                <span class="material-symbols-outlined ${statusColor}">${isCorrect ? 'check_circle' : 'cancel'}</span>
            </div>
            <p class="text-sm text-slate-700 dark:text-slate-300 mb-3">${q.text}</p>
            <div class="text-xs space-y-1 font-mono">
                <p>Your Answer: <span class="font-bold ${answers[i] === correctLabel ? '' : 'text-red-500 dark:text-red-400'}">${answers[i] || 'None'}</span></p>
                <p>Correct Answer: <span class="font-bold text-emerald-600 dark:text-emerald-400">${correctLabel}</span></p>
            </div>
            ${q.explanation ? `<div class="mt-3 text-xs text-slate-500 dark:text-slate-400 border-t border-border-light dark:border-border-dark pt-2">${q.explanation}</div>` : ''}
        </div>`;
    }).join('');
    
    const headerHtml = `
        <div class="text-center p-6">
            <div class="text-5xl font-black">${Math.round((correctCount/quizData.length)*100)}%</div>
            <p class="text-slate-500 dark:text-slate-400 mt-1">Final Score: ${correctCount} / ${quizData.length} Correct</p>
        </div>
    `;
    list.insertAdjacentHTML('afterbegin', headerHtml);

    modal.style.display = 'flex';
    if(correctCount === quizData.length && typeof confetti === 'function') {
      confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
    }
    
    firstIncorrectElement = list.querySelector('.incorrect');
    if (firstIncorrectElement) {
        renderResultsPdfPage(firstIncorrectPage, firstIncorrectElement);
        firstIncorrectElement.scrollIntoView({behavior: 'smooth'});
    } else if (quizData.length > 0) {
        renderResultsPdfPage(quizData[0].page_ref, list.querySelector('.result-item'));
    }
}

function renderResultsPdfPage(num, clickedElement) {
    if (clickedElement) {
        document.querySelectorAll('.result-item').forEach(el => el.classList.remove('bg-blue-50', 'dark:bg-blue-900/20'));
        clickedElement.classList.add('bg-blue-50', 'dark:bg-blue-900/20');
    }

    if(!pdfDoc || !num) {
        const canvas = document.getElementById('results-pdf-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width, canvas.height);
        return;
    };
    
    pdfDoc.getPage(num).then(page => {
        const canvas = document.getElementById('results-pdf-canvas');
        const ctx = canvas.getContext('2d');
        const viewport = page.getViewport({scale: 1.2});
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        page.render({ canvasContext: ctx, viewport: viewport });
    });
}
</script>
</body>
</html>
